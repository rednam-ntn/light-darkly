# ============================================
# Docker Compose - Development Configuration
# ============================================
# NOTE: 'version' is optional in Docker Compose V2+

services:
  # ==================== APPLICATION ====================
  app:
    build:
      context: .
      dockerfile: Dockerfile
      target: builder  # Use builder stage for dev (hot reload)
    ports:
      - "${PORT:-3000}:3000"
    environment:
      - NODE_ENV=development
      - DATABASE_URL=${DATABASE_URL:-file:./prisma/dev.db}
    volumes:
      # Mount source code for hot reload
      - .:/app
      # Exclude node_modules (use container's modules)
      - /app/node_modules
      # SQLite database persistence
      - ./prisma/dev.db:/app/prisma/dev.db
    command: npm run dev
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    networks:
      - app-network

  # ==================== DATABASES ====================
  # Uncomment the database you need

  # ---------- PostgreSQL ----------
  # postgres:
  #   image: postgres:16-alpine
  #   environment:
  #     POSTGRES_USER: ${DB_USER:-postgres}
  #     POSTGRES_PASSWORD: ${DB_PASSWORD:-postgres}
  #     POSTGRES_DB: ${DB_NAME:-app}
  #   volumes:
  #     - postgres_data:/var/lib/postgresql/data
  #   ports:
  #     - "5432:5432"
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-postgres}"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5
  #   networks:
  #     - app-network

  # ---------- MySQL ----------
  # mysql:
  #   image: mysql:8.0
  #   environment:
  #     MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-root}
  #     MYSQL_DATABASE: ${DB_NAME:-app}
  #     MYSQL_USER: ${DB_USER:-app}
  #     MYSQL_PASSWORD: ${DB_PASSWORD:-secret}
  #   volumes:
  #     - mysql_data:/var/lib/mysql
  #   ports:
  #     - "3306:3306"
  #   healthcheck:
  #     test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5
  #   networks:
  #     - app-network

  # ---------- MongoDB ----------
  # mongo:
  #   image: mongo:7
  #   environment:
  #     MONGO_INITDB_ROOT_USERNAME: ${MONGO_USER:-root}
  #     MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD:-secret}
  #     MONGO_INITDB_DATABASE: ${DB_NAME:-app}
  #   volumes:
  #     - mongo_data:/data/db
  #   ports:
  #     - "27017:27017"
  #   healthcheck:
  #     test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5
  #   networks:
  #     - app-network

  # ---------- Redis ----------
  # redis:
  #   image: redis:7-alpine
  #   command: redis-server --appendonly yes
  #   volumes:
  #     - redis_data:/data
  #   ports:
  #     - "6379:6379"
  #   healthcheck:
  #     test: ["CMD", "redis-cli", "ping"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5
  #   networks:
  #     - app-network

  # ==================== ADDITIONAL SERVICES ====================

  # ---------- Adminer (Database UI) ----------
  # adminer:
  #   image: adminer:latest
  #   ports:
  #     - "8080:8080"
  #   networks:
  #     - app-network
  #   depends_on:
  #     - postgres  # or mysql

  # ---------- Mailpit (Email Testing) ----------
  # mailpit:
  #   image: axllent/mailpit:latest
  #   ports:
  #     - "8025:8025"   # Web UI
  #     - "1025:1025"   # SMTP
  #   networks:
  #     - app-network

  # ---------- MinIO (S3-compatible storage) ----------
  # minio:
  #   image: minio/minio:latest
  #   command: server /data --console-address ":9001"
  #   environment:
  #     MINIO_ROOT_USER: ${MINIO_USER:-minio}
  #     MINIO_ROOT_PASSWORD: ${MINIO_PASSWORD:-minio123}
  #   volumes:
  #     - minio_data:/data
  #   ports:
  #     - "9000:9000"
  #     - "9001:9001"
  #   networks:
  #     - app-network

# ==================== VOLUMES ====================
volumes:
  postgres_data:
  mysql_data:
  mongo_data:
  redis_data:
  minio_data:

# ==================== NETWORKS ====================
networks:
  app-network:
    driver: bridge
